<!DOCTYPE html>
<html lang="en" dir="ltr"><head><title>Optimize single-box NGINX performance</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Schibsted Grotesk:wght@400;700&amp;family=Source Sans Pro:ital,wght@0,400;0,600;1,400;1,600&amp;family=IBM Plex Mono:wght@400;600&amp;display=swap"/><link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin="anonymous"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="og:site_name" content="ü™¥ Zero's Garden"/><meta property="og:title" content="Optimize single-box NGINX performance"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Optimize single-box NGINX performance"/><meta name="twitter:description" content="NUMA topology AMD recommends pinning instances within a NUMA node, but does not recommend doing so via the application-level worker_cpu_affinity option."/><meta property="og:description" content="NUMA topology AMD recommends pinning instances within a NUMA node, but does not recommend doing so via the application-level worker_cpu_affinity option."/><meta property="og:image:alt" content="NUMA topology AMD recommends pinning instances within a NUMA node, but does not recommend doing so via the application-level worker_cpu_affinity option."/><meta property="og:image" content="https://l2dy.github.io/static/og-image.png"/><meta property="og:image:url" content="https://l2dy.github.io/static/og-image.png"/><meta name="twitter:image" content="https://l2dy.github.io/static/og-image.png"/><meta property="og:image:type" content="image/.png"/><meta property="twitter:domain" content="l2dy.github.io"/><meta property="og:url" content="https://l2dy.github.io/notes/Performance-tuning/Optimize-single-box-NGINX-performance"/><meta property="twitter:url" content="https://l2dy.github.io/notes/Performance-tuning/Optimize-single-box-NGINX-performance"/><link rel="icon" href="../../static/icon.png"/><meta name="description" content="NUMA topology AMD recommends pinning instances within a NUMA node, but does not recommend doing so via the application-level worker_cpu_affinity option."/><meta name="generator" content="Quartz"/><link href="../../index.css" rel="stylesheet" type="text/css" data-persist="true"/><style>.expand-button {
  position: absolute;
  display: flex;
  float: right;
  padding: 0.4rem;
  margin: 0.3rem;
  right: 0;
  color: var(--gray);
  border-color: var(--dark);
  background-color: var(--light);
  border: 1px solid;
  border-radius: 5px;
  opacity: 0;
  transition: 0.2s;
}
.expand-button > svg {
  fill: var(--light);
  filter: contrast(0.3);
}
.expand-button:hover {
  cursor: pointer;
  border-color: var(--secondary);
}
.expand-button:focus {
  outline: 0;
}

pre:hover > .expand-button {
  opacity: 1;
  transition: 0.2s;
}

#mermaid-container {
  position: fixed;
  contain: layout;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  display: none;
  backdrop-filter: blur(4px);
  background: rgba(0, 0, 0, 0.5);
}
#mermaid-container.active {
  display: inline-block;
}
#mermaid-container > #mermaid-space {
  border: 1px solid var(--lightgray);
  background-color: var(--light);
  border-radius: 5px;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  height: 80vh;
  width: 80vw;
  overflow: hidden;
}
#mermaid-container > #mermaid-space > .mermaid-content {
  position: relative;
  transform-origin: 0 0;
  transition: transform 0.1s ease;
  overflow: visible;
  min-height: 200px;
  min-width: 200px;
}
#mermaid-container > #mermaid-space > .mermaid-content pre {
  margin: 0;
  border: none;
}
#mermaid-container > #mermaid-space > .mermaid-content svg {
  max-width: none;
  height: auto;
}
#mermaid-container > #mermaid-space > .mermaid-controls {
  position: absolute;
  bottom: 20px;
  right: 20px;
  display: flex;
  gap: 8px;
  padding: 8px;
  background: var(--light);
  border: 1px solid var(--lightgray);
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  z-index: 2;
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  padding: 0;
  border: 1px solid var(--lightgray);
  background: var(--light);
  color: var(--dark);
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  font-family: var(--bodyFont);
  transition: all 0.2s ease;
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button:hover {
  background: var(--lightgray);
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button:active {
  transform: translateY(1px);
}
#mermaid-container > #mermaid-space > .mermaid-controls .mermaid-control-button:nth-child(2) {
  width: auto;
  padding: 0 12px;
  font-size: 14px;
}
/*# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VSb290IjoiL1VzZXJzL2wyZHkvUmVwb3MvYmxvZy1vYnNpZGlhbi9xdWFydHovY29tcG9uZW50cy9zdHlsZXMiLCJzb3VyY2VzIjpbIm1lcm1haWQuaW5saW5lLnNjc3MiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7RUFDRTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTs7QUFFQTtFQUNFO0VBQ0E7O0FBR0Y7RUFDRTtFQUNBOztBQUdGO0VBQ0U7OztBQUtGO0VBQ0U7RUFDQTs7O0FBSUo7RUFDRTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBOztBQUVBO0VBQ0U7O0FBR0Y7RUFDRTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTs7QUFFQTtFQUNFO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTs7QUFFQTtFQUNFO0VBQ0E7O0FBR0Y7RUFDRTtFQUNBOztBQUlKO0VBQ0U7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTs7QUFFQTtFQUNFO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7O0FBRUE7RUFDRTs7QUFHRjtFQUNFOztBQUlGO0VBQ0U7RUFDQTtFQUNBIiwic291cmNlc0NvbnRlbnQiOlsiLmV4cGFuZC1idXR0b24ge1xuICBwb3NpdGlvbjogYWJzb2x1dGU7XG4gIGRpc3BsYXk6IGZsZXg7XG4gIGZsb2F0OiByaWdodDtcbiAgcGFkZGluZzogMC40cmVtO1xuICBtYXJnaW46IDAuM3JlbTtcbiAgcmlnaHQ6IDA7IC8vIE5PVEU6IHJpZ2h0IHdpbGwgYmUgc2V0IGluIG1lcm1haWQuaW5saW5lLnRzXG4gIGNvbG9yOiB2YXIoLS1ncmF5KTtcbiAgYm9yZGVyLWNvbG9yOiB2YXIoLS1kYXJrKTtcbiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tbGlnaHQpO1xuICBib3JkZXI6IDFweCBzb2xpZDtcbiAgYm9yZGVyLXJhZGl1czogNXB4O1xuICBvcGFjaXR5OiAwO1xuICB0cmFuc2l0aW9uOiAwLjJzO1xuXG4gICYgPiBzdmcge1xuICAgIGZpbGw6IHZhcigtLWxpZ2h0KTtcbiAgICBmaWx0ZXI6IGNvbnRyYXN0KDAuMyk7XG4gIH1cblxuICAmOmhvdmVyIHtcbiAgICBjdXJzb3I6IHBvaW50ZXI7XG4gICAgYm9yZGVyLWNvbG9yOiB2YXIoLS1zZWNvbmRhcnkpO1xuICB9XG5cbiAgJjpmb2N1cyB7XG4gICAgb3V0bGluZTogMDtcbiAgfVxufVxuXG5wcmUge1xuICAmOmhvdmVyID4gLmV4cGFuZC1idXR0b24ge1xuICAgIG9wYWNpdHk6IDE7XG4gICAgdHJhbnNpdGlvbjogMC4ycztcbiAgfVxufVxuXG4jbWVybWFpZC1jb250YWluZXIge1xuICBwb3NpdGlvbjogZml4ZWQ7XG4gIGNvbnRhaW46IGxheW91dDtcbiAgei1pbmRleDogOTk5O1xuICBsZWZ0OiAwO1xuICB0b3A6IDA7XG4gIHdpZHRoOiAxMDB2dztcbiAgaGVpZ2h0OiAxMDB2aDtcbiAgb3ZlcmZsb3c6IGhpZGRlbjtcbiAgZGlzcGxheTogbm9uZTtcbiAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDRweCk7XG4gIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC41KTtcblxuICAmLmFjdGl2ZSB7XG4gICAgZGlzcGxheTogaW5saW5lLWJsb2NrO1xuICB9XG5cbiAgJiA+ICNtZXJtYWlkLXNwYWNlIHtcbiAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1saWdodGdyYXkpO1xuICAgIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWxpZ2h0KTtcbiAgICBib3JkZXItcmFkaXVzOiA1cHg7XG4gICAgcG9zaXRpb246IGZpeGVkO1xuICAgIHRvcDogNTAlO1xuICAgIGxlZnQ6IDUwJTtcbiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTtcbiAgICBoZWlnaHQ6IDgwdmg7XG4gICAgd2lkdGg6IDgwdnc7XG4gICAgb3ZlcmZsb3c6IGhpZGRlbjtcblxuICAgICYgPiAubWVybWFpZC1jb250ZW50IHtcbiAgICAgIHBvc2l0aW9uOiByZWxhdGl2ZTtcbiAgICAgIHRyYW5zZm9ybS1vcmlnaW46IDAgMDtcbiAgICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjFzIGVhc2U7XG4gICAgICBvdmVyZmxvdzogdmlzaWJsZTtcbiAgICAgIG1pbi1oZWlnaHQ6IDIwMHB4O1xuICAgICAgbWluLXdpZHRoOiAyMDBweDtcblxuICAgICAgcHJlIHtcbiAgICAgICAgbWFyZ2luOiAwO1xuICAgICAgICBib3JkZXI6IG5vbmU7XG4gICAgICB9XG5cbiAgICAgIHN2ZyB7XG4gICAgICAgIG1heC13aWR0aDogbm9uZTtcbiAgICAgICAgaGVpZ2h0OiBhdXRvO1xuICAgICAgfVxuICAgIH1cblxuICAgICYgPiAubWVybWFpZC1jb250cm9scyB7XG4gICAgICBwb3NpdGlvbjogYWJzb2x1dGU7XG4gICAgICBib3R0b206IDIwcHg7XG4gICAgICByaWdodDogMjBweDtcbiAgICAgIGRpc3BsYXk6IGZsZXg7XG4gICAgICBnYXA6IDhweDtcbiAgICAgIHBhZGRpbmc6IDhweDtcbiAgICAgIGJhY2tncm91bmQ6IHZhcigtLWxpZ2h0KTtcbiAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWxpZ2h0Z3JheSk7XG4gICAgICBib3JkZXItcmFkaXVzOiA2cHg7XG4gICAgICBib3gtc2hhZG93OiAwIDJweCA0cHggcmdiYSgwLCAwLCAwLCAwLjEpO1xuICAgICAgei1pbmRleDogMjtcblxuICAgICAgLm1lcm1haWQtY29udHJvbC1idXR0b24ge1xuICAgICAgICBkaXNwbGF5OiBmbGV4O1xuICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyO1xuICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjtcbiAgICAgICAgd2lkdGg6IDMycHg7XG4gICAgICAgIGhlaWdodDogMzJweDtcbiAgICAgICAgcGFkZGluZzogMDtcbiAgICAgICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tbGlnaHRncmF5KTtcbiAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tbGlnaHQpO1xuICAgICAgICBjb2xvcjogdmFyKC0tZGFyayk7XG4gICAgICAgIGJvcmRlci1yYWRpdXM6IDRweDtcbiAgICAgICAgY3Vyc29yOiBwb2ludGVyO1xuICAgICAgICBmb250LXNpemU6IDE2cHg7XG4gICAgICAgIGZvbnQtZmFtaWx5OiB2YXIoLS1ib2R5Rm9udCk7XG4gICAgICAgIHRyYW5zaXRpb246IGFsbCAwLjJzIGVhc2U7XG5cbiAgICAgICAgJjpob3ZlciB7XG4gICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tbGlnaHRncmF5KTtcbiAgICAgICAgfVxuXG4gICAgICAgICY6YWN0aXZlIHtcbiAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMXB4KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFN0eWxlIHRoZSByZXNldCBidXR0b24gZGlmZmVyZW50bHlcbiAgICAgICAgJjpudGgtY2hpbGQoMikge1xuICAgICAgICAgIHdpZHRoOiBhdXRvO1xuICAgICAgICAgIHBhZGRpbmc6IDAgMTJweDtcbiAgICAgICAgICBmb250LXNpemU6IDE0cHg7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ== */</style><link href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" rel="stylesheet" type="text/css" data-persist="true"/><script src="../../prescript.js" type="application/javascript" data-persist="true"></script><script type="application/javascript" data-persist="true">const fetchData = fetch("../../static/contentIndex.json").then(data => data.json())</script><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://l2dy.github.io/index.xml"/></head><body data-slug="notes/Performance-tuning/Optimize-single-box-NGINX-performance"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h2 class="page-title"><a href="../..">ü™¥ Zero's Garden</a></h2><div class="spacer mobile-only"></div><div class="flex-component" style="flex-direction: row; flex-wrap: nowrap; gap: 1rem;"><div style="flex-grow: 1; flex-shrink: 1; flex-basis: auto; order: 0; align-self: center; justify-self: center;"><div class="search"><button class="search-button"><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title>Search</title><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg><p>Search</p></button><div class="search-container"><div class="search-space"><input autocomplete="off" class="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div class="search-layout" data-preview="true"></div></div></div></div></div><div style="flex-grow: 0; flex-shrink: 1; flex-basis: auto; order: 0; align-self: center; justify-self: center;"><button class="darkmode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35" xml:space="preserve" aria-label="Dark mode"><title>Dark mode</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100" xml:space="preserve" aria-label="Light mode"><title>Light mode</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"></path></svg></button></div><div style="flex-grow: 0; flex-shrink: 1; flex-basis: auto; order: 0; align-self: center; justify-self: center;"><button class="readermode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="readerIcon" fill="currentColor" stroke="currentColor" stroke-width="0.2" stroke-linecap="round" stroke-linejoin="round" width="64px" height="64px" viewBox="0 0 24 24" aria-label="Reader mode"><title>Reader mode</title><g transform="translate(-1.8, -1.8) scale(1.15, 1.2)"><path d="M8.9891247,2.5 C10.1384702,2.5 11.2209868,2.96705384 12.0049645,3.76669482 C12.7883914,2.96705384 13.8709081,2.5 15.0202536,2.5 L18.7549359,2.5 C19.1691495,2.5 19.5049359,2.83578644 19.5049359,3.25 L19.5046891,4.004 L21.2546891,4.00457396 C21.6343849,4.00457396 21.9481801,4.28672784 21.9978425,4.6528034 L22.0046891,4.75457396 L22.0046891,20.25 C22.0046891,20.6296958 21.7225353,20.943491 21.3564597,20.9931534 L21.2546891,21 L2.75468914,21 C2.37499337,21 2.06119817,20.7178461 2.01153575,20.3517706 L2.00468914,20.25 L2.00468914,4.75457396 C2.00468914,4.37487819 2.28684302,4.061083 2.65291858,4.01142057 L2.75468914,4.00457396 L4.50368914,4.004 L4.50444233,3.25 C4.50444233,2.87030423 4.78659621,2.55650904 5.15267177,2.50684662 L5.25444233,2.5 L8.9891247,2.5 Z M4.50368914,5.504 L3.50468914,5.504 L3.50468914,19.5 L10.9478955,19.4998273 C10.4513189,18.9207296 9.73864328,18.5588115 8.96709342,18.5065584 L8.77307039,18.5 L5.25444233,18.5 C4.87474657,18.5 4.56095137,18.2178461 4.51128895,17.8517706 L4.50444233,17.75 L4.50368914,5.504 Z M19.5049359,17.75 C19.5049359,18.1642136 19.1691495,18.5 18.7549359,18.5 L15.2363079,18.5 C14.3910149,18.5 13.5994408,18.8724714 13.0614828,19.4998273 L20.5046891,19.5 L20.5046891,5.504 L19.5046891,5.504 L19.5049359,17.75 Z M18.0059359,3.999 L15.0202536,4 L14.8259077,4.00692283 C13.9889509,4.06666544 13.2254227,4.50975805 12.7549359,5.212 L12.7549359,17.777 L12.7782651,17.7601316 C13.4923805,17.2719483 14.3447024,17 15.2363079,17 L18.0059359,16.999 L18.0056891,4.798 L18.0033792,4.75457396 L18.0056891,4.71 L18.0059359,3.999 Z M8.9891247,4 L6.00368914,3.999 L6.00599909,4.75457396 L6.00599909,4.75457396 L6.00368914,4.783 L6.00368914,16.999 L8.77307039,17 C9.57551536,17 10.3461406,17.2202781 11.0128313,17.6202194 L11.2536891,17.776 L11.2536891,5.211 C10.8200889,4.56369974 10.1361548,4.13636104 9.37521067,4.02745763 L9.18347055,4.00692283 L8.9891247,4 Z"></path></g></svg></button></div></div><div class="explorer" data-behavior="link" data-collapsed="collapsed" data-savestate="true" data-data-fns="{&quot;order&quot;:[&quot;filter&quot;,&quot;map&quot;,&quot;sort&quot;],&quot;sortFn&quot;:&quot;(a,b)=>!a.isFolder&amp;&amp;!b.isFolder||a.isFolder&amp;&amp;b.isFolder?a.displayName.localeCompare(b.displayName,void 0,{numeric:!0,sensitivity:\&quot;base\&quot;}):!a.isFolder&amp;&amp;b.isFolder?1:-1&quot;,&quot;filterFn&quot;:&quot;node=>node.slugSegment!==\&quot;tags\&quot;&quot;,&quot;mapFn&quot;:&quot;node=>node&quot;}"><button type="button" class="explorer-toggle mobile-explorer hide-until-loaded" data-mobile="true" aria-controls="explorer-447"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-menu"><line x1="4" x2="20" y1="12" y2="12"></line><line x1="4" x2="20" y1="6" y2="6"></line><line x1="4" x2="20" y1="18" y2="18"></line></svg></button><button type="button" class="title-button explorer-toggle desktop-explorer" data-mobile="false" aria-expanded="true"><h2>Explorer</h2><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="explorer-447" class="explorer-content" aria-expanded="false" role="group"><ul class="explorer-ul overflow" id="list-0"><li class="overflow-end"></li></ul></div><template id="template-file"><li><a href="#"></a></li></template><template id="template-folder"><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div><button class="folder-button"><span class="folder-title"></span></button></div></div><div class="folder-outer"><ul class="content"></ul></div></li></template></div></div><div class="center"><div class="page-header"><div class="popover-hint"><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="../../">Home</a><p> ‚ùØ </p></div><div class="breadcrumb-element"><a href="../../notes/">notes</a><p> ‚ùØ </p></div><div class="breadcrumb-element"><a href="../../notes/Performance-tuning/">Performance tuning</a><p> ‚ùØ </p></div><div class="breadcrumb-element"><a href>Optimize single box NGINX performance</a></div></nav><h1 class="article-title">Optimize single-box NGINX performance</h1><p show-comma="true" class="content-meta"><time>Jun 09, 2024</time><span>9 min read</span></p><div><iframe class="gh-sponsor" src="https://github.com/sponsors/l2dy/button" title="Sponsor l2dy" height="32" width="114"></iframe></div><ul class="tags"><li><a href="../../tags/tcp" class="internal tag-link">tcp</a></li></ul></div></div><article class="popover-hint"><h1 id="numa-topology">NUMA topology<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#numa-topology" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<p>AMD recommends pinning instances within a NUMA node, but does not recommend doing so via the application-level <code>worker_cpu_affinity</code> option.</p>
<p>NGINX‚Äôs <code>worker_cpu_affinity</code> option may lower performance by increasing the time a process spends waiting for a free CPU. This can be monitored by running <code>runqlat</code> on one of NGINX workers‚Äôs PIDs. On the other hand, <code>worker_cpu_affinity</code> eliminates CPU migrations, reduce cache misses and page faults, and slightly increases instructions per cycle. All of which can be verified with <code>perf stat</code>.</p>
<h2 id="node-per-socket-nps-settings">Node Per Socket (NPS) settings<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#node-per-socket-nps-settings" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>For example, a 96-core processor with 96 vCPUs per NGINX instance (2 instances in total) should set NPS2 in BIOS, with each NGINX instance pinned to a NUMA node.</p>
<p>For NIC tuning, AMD recommends a combination of NPS=1 with LLC as NUMA enabled. Here, LLC means Last Level Cache, or L3 cache, so the OS will see one NUMA node per L3 cache. This can help the OS schedulers maintain locality to the LLC without causing unnecessary cache-to-cache transactions.</p>
<p>If deployment restrictions prevent pinning of VM or NGINX instances, NPS1 will deliver the most consistent performance. This is the best trade-off for this situation, according to AMD.</p>
<h1 id="nic-configuration">NIC configuration<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#nic-configuration" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<h2 id="configure-nic-queues">Configure NIC queues<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#configure-nic-queues" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Broadcom recommends the use of combined queues no more than a single IRQ per <strong>physical core</strong>.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ethtool</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [interface] combined 8 tx 0 rx 0</span></span></code></pre></figure>
<p>Ensure IRQ distribution, i.e. CPU affinity for the NIC queue interrupts, is properly set up. AWS does not recommend disabling the <code>irqbalance</code> service because its ENA driver doesn‚Äôt provide affinity hints, and if device reset happens while irqbalance is disabled, this might cause undesirable IRQ distribution. On bare-metal, this could be another case.</p>
<h2 id="rx-and-tx-ring-sizes">RX and TX ring sizes<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#rx-and-tx-ring-sizes" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>AMD recommends setting the maximum allowable ring size to boost network performance, but not on older kernels or derivers without byte queue limit support (non-BQL drivers).</p>
<p>Broadcom does not suggest this for all cases as it could result in higher latency and other side effects.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ethtool</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -G</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [interface] tx 2047 rx 2047</span></span></code></pre></figure>
<h2 id="interrupt-coalescing">Interrupt coalescing<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#interrupt-coalescing" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Broadcom recommends enabling <code>adaptive-rx</code> to improve RX latency or throughput adaptively.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ethtool</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [interface] adaptive-rx on</span></span></code></pre></figure>
<h2 id="gro-generic-receive-offload">GRO (Generic Receive Offload)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#gro-generic-receive-offload" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>This should be <strong>disabled</strong> on routers and bridges, including virtual hosts using bridging. See also <a href="../../notes/Network/NIC-offload" class="internal alias" data-slug="notes/Network/NIC-offload">NIC offload</a>.</p>
<p>Broadcom NICs support Hardware GRO, which can be enabled with the following command.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ethtool</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -K</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [interface] rx-gro-hw on lro off gro on</span></span></code></pre></figure>
<h1 id="system-configuration">System configuration<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#system-configuration" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<h2 id="linux-kernel-version">Linux kernel version<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#linux-kernel-version" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>AMD recommends using Linux kernel 5.20 or newer that includes IOMMU optimized patches.</p>
<h2 id="cpu-scaling-governor">CPU scaling governor<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#cpu-scaling-governor" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Set the CPU scaling governor to Performance mode.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> performance</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tee</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sys/devices/system/cpu/cpu</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/cpufreq/scaling_governor</span></span></code></pre></figure>
<p>On Ubuntu, you can use <code>cpupower</code> as well.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cpupower</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> frequency-set</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -g</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> performance</span></span></code></pre></figure>
<p>Note: C0 is active state and Cx is sleep state in <code>cpupower monitor -i 60 -m Mperf</code>.</p>
<h2 id="configure-limits">Configure limits<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#configure-limits" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Add the following configuration to a new file in <code>/etc/security/limits.d/*.conf</code>, if your current limit is lower.</p>
<pre><code>#nproc ‚Äì number of processes
#nofile ‚Äì number of file descriptors
* soft nproc 32768
* hard nproc 65535
* soft nofile 32768
* hard nofile 65535
root soft nproc 32768
root hard nproc 65535
root soft nofile 32768
root hard nofile 65535
</code></pre>
<p>Then, add <code>LimitNOFILE=65535</code> option to <code>nginx.service</code> or set <code>worker_rlimit_nofile</code> in NGINX configuration to increase the maximum number of open files for worker processes.</p>
<h2 id="firewall">Firewall<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#firewall" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>AMD recommends disabling the firewall if possible to improve performance.</p>
<p>If you have firewall and connection tracking enabled, make sure <code>nf_conntrack_max</code> is set to an appropriate value.</p>
<h2 id="transparent-hugepages-thp">Transparent hugepages (THP)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#transparent-hugepages-thp" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Make it opt-in with <code>madvise</code>. Only enable THP if you are sure they are beneficial.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> madvise</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tee</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sys/kernel/mm/transparent_hugepage/enabled</span></span></code></pre></figure>
<h2 id="sysctl">sysctl<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#sysctl" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>This is a sample <code>sysctl.conf</code> based on various sources including AMD‚Äôs recommendations.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="ini" data-theme="github-light github-dark"><code data-language="ini" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># /etc/sysctl.conf</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">########## Kernel ##############</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Controls the System Request debugging functionality of the kernel</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">kernel.sysrq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Controls whether core dumps will append the PID to the core</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># filename. Useful for debugging multi-threaded applications</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">kernel.core_uses_pid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 1</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># increase system file descriptor limit</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fs.file-max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 65535</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Allow for more PIDs</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">kernel.pid_max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 65536</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">########## Swap ##############</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">vm.swappiness</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 10 </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Favor RAM over swap</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Disk Caching. Data isn't critical and can be lost? Favor raising the cache.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># NOT recommended on modern systems with very alrge amounts of RAM. Comment it out!</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">vm.vfs_cache_pressure</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 50</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">vm.dirty_background_ratio</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 50</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">vm.dirty_ratio</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 80</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">########## IPv4 networking ##############</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Controls IP packet forwarding</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.ip_forward</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Do not accept source routing</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.conf.default.accept_source_route</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Send redirects, if router, but this is just server</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.conf.all.send_redirects</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.conf.default.send_redirects</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Accept packets with SRR option? No</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.conf.all.accept_source_route</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Accept Redirects? No, this is not router</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.conf.all.accept_redirects</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.conf.all.secure_redirects</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Log packets with impossible addresses to kernel log? yes</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.conf.all.log_martians</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 1</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.conf.default.log_martians</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 1</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.conf.default.accept_source_route</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.conf.default.accept_redirects</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.conf.default.secure_redirects</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Ignore all ICMP ECHO and TIMESTAMP requests sent to it via broadcast/multicast</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.icmp_echo_ignore_broadcasts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 1</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Turn on protection for bad icmp error messages</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.icmp_ignore_bogus_error_responses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 1</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Prevent against the common 'syn flood attack'</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.tcp_syncookies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 1</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Controls the use of TCP syncookies</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.tcp_synack_retries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 2</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Enable source validation by reversed path, as specified in RFC1812</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.conf.all.rp_filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 1</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.conf.default.rp_filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 1</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># TCP and memory optimization</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># increase TCP max buffer size to 8MiB</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.tcp_rmem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 4096 131072 8388608</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.tcp_wmem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 4096 16384 8388608</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># increase Linux auto tuning TCP buffer limits</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.core.rmem_max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 8388608</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.core.wmem_max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 8388608</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.core.netdev_max_backlog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 5000</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.tcp_window_scaling</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 1</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#Increase system IP port limits</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.ip_local_port_range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 2000 65499</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.tcp_tw_reuse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 1</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.tcp_fin_timeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 60</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.tcp_slow_start_after_idle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Recommended for hosts with jumbo frames enabled</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.tcp_mtu_probing</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 1</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># TCP Fast Open</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv4.tcp_fastopen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 3</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#net.ipv4.tcp_congestion_control = cubic</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">########## IPv4 networking ends ##############</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">########## IPv6 networking start ##############</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Number of Router Solicitations to send until assuming no routers are present.</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># This is host and not router</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv6.conf.default.router_solicitations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Accept Router Preference in RA?</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv6.conf.default.accept_ra_rtr_pref</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Learn Prefix Information in Router Advertisement</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv6.conf.default.accept_ra_pinfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Setting controls whether the system will accept Hop Limit settings</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># from a router advertisement</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv6.conf.default.accept_ra_defrtr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Router Advertisements can cause the system to assign a global unicast</span></span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># address to an interface</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv6.conf.default.autoconf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># how many neighbor solicitations to send out per address?</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv6.conf.default.dad_transmits</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 0</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># How many global unicast IPv6 addresses can be assigned to each interface?</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">net.ipv6.conf.default.max_addresses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 1</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">########## IPv6 networking ends ##############</span></span></code></pre></figure>
<p>For Ubuntu 24.04.2 servers, you can use the following config:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># /etc/sysctl.d/local.conf</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.core.somaxconn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=65535</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_max_syn_backlog</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=65535</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.core.netdev_max_backlog</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=65535</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_fin_timeout</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=30</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.ip_local_port_range</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=10000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 65499</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_tw_reuse</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=1</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_syncookies</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=1</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_synack_retries</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=2</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_syn_retries</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=2</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_rmem</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=4096</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 131072</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8388608</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_wmem</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=4096</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 16384</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8388608</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.core.rmem_max</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=8388608</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.core.wmem_max</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=8388608</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_slow_start_after_idle</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=0</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_mtu_probing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=1</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vm.swappiness</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=10</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.netfilter.nf_conntrack_max</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=524288</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.netfilter.nf_conntrack_buckets</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=524288</span></span></code></pre></figure>
<p>For memory usage optimization, also add:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="bash" data-theme="github-light github-dark"><code data-language="bash" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_notsent_lowat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=131072</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.ipv4.tcp_shrink_window</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=1</span></span></code></pre></figure>
<h1 id="nginx-configuration">NGINX configuration<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#nginx-configuration" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<h2 id="event-handling">Event handling<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#event-handling" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<ul>
<li>Consider enabling¬†<code>multi_accept</code>¬†if your workload shows benefits.</li>
</ul>
<h2 id="open-file-cache">Open file cache<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#open-file-cache" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Useful for serving lots of static or cached data. See official documentation for the <code>open_file_cache*</code> directives. Check potential benefits with:</p>
<pre><code># funclatency /srv/nginx-bazel/sbin/nginx:ngx_open_cached_file -u
     usecs               : count     distribution
         0 -&amp;gt; 1          : 10219    |****************************************|
         2 -&amp;gt; 3          : 21       |                                        |
         4 -&amp;gt; 7          : 3        |                                        |
         8 -&amp;gt; 15         : 1        |                                        |
</code></pre>
<p>If there are too many open calls or there are some that take too much time, you can look at enabling the open file cache.</p>
<h2 id="http-keepalive">HTTP keepalive<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#http-keepalive" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><code>keepalive_requests</code> can be increased, at the risk of introducing additional DDoS attack vectors.</p>
<p>See also <a href="../../notes/NGINX/proxy/Upstream-Keepalive" class="internal alias" data-slug="notes/NGINX/proxy/Upstream-Keepalive">Upstream Keepalive</a>.</p>
<h2 id="buffering-requests-and-responses-with-large-body">Buffering requests and responses with large body<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#buffering-requests-and-responses-with-large-body" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>For buffering the request body, enabling <code>sendfile</code> improves performance for requests with large content size (>1MB) and results in a small performance loss for requests with small content sizes. AMD recommends setting <code>sendfile_max_chunk</code> to the typical average request size.</p>
<p>Enabling <code>tcp_nopush</code> can be beneficial to serving large content to users by maxing out packet size until the file is fully sent.</p>
<pre><code>sendfile on;
tcp_nopush on;
</code></pre>
<p>Utilizing kTLS (Kernel TLS offload) can significantly improve <code>sendfile</code> performance. Its configuration depends on the operating system and TLS library used.</p>
<h2 id="worker-configuration">Worker configuration<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#worker-configuration" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<ul>
<li><code>worker_processes</code> should be set to the number of vCPUs.</li>
<li><code>worker_connections</code> should be increased as needed, and ensure you set¬†<code>worker_rlimit_nofile</code> or modify the limits in systemd unit definition¬†accordingly.</li>
</ul>
<h2 id="logging">Logging<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#logging" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Use <code>ext4slower</code> to identify disk I/O latency issues. Enable buffering and gzip for the <code>access_log</code> directive to help reduce blocking on I/O.</p>
<p>If multiple NGINX processes attempt to write to the same log file, lock contention could be a dominating factor in your CPU profile.</p>
<h2 id="caching-and-compression">Caching and compression<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#caching-and-compression" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Properly configured cache can increase performance, especially if serving stale content is enabled. Make sure there is sufficient RAM to store the hot cached content in OS page cache.</p>
<p>NGINX supports Gzip compression, which accelerates the transfer rate from the server to the client and reduces bandwidth usage.</p>
<h2 id="enable-aio-asynchronous-file-io">Enable AIO (Asynchronous file I/O)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#enable-aio-asynchronous-file-io" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Write temporary files with data received from proxied servers with AIO to boost performance.</p>
<p>If you have a reasonable amount of RAM, you are not using spinning disks and your working data set isn‚Äôt very big, NGINX can utilize OS page cache recommends not enabling AIO to reduce the overhead of offloading.</p>
<pre><code>aio threads;
aio_write on;
</code></pre>
<h2 id="enable-pcre-jit">Enable PCRE JIT<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#enable-pcre-jit" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>JIT can speed up processing of regular expressions significantly if you have a lot of them.</p>
<pre><code>pcre_jit on;
</code></pre>
<h2 id="http2-prioritization">HTTP/2 prioritization<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#http2-prioritization" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<pre><code>tcp_notsent_lowat - UNSIGNED INTEGER
	A TCP socket can control the amount of unsent bytes in its write queue,
	thanks to TCP_NOTSENT_LOWAT socket option. poll()/select()/epoll()
	reports POLLOUT events if the amount of unsent bytes is below a per
	socket value, and if the write queue is not full. sendmsg() will
	also not add new buffers if the limit is hit.

	This global variable controls the amount of unsent data for
	sockets not using TCP_NOTSENT_LOWAT. For these sockets, a change
	to the global variable has immediate effect.

	Default: UINT_MAX (0xFFFFFFFF)
</code></pre>
<h2 id="detect-event-loop-stalls">Detect event loop stalls<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#detect-event-loop-stalls" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>If you start noticing that your nginx is spending too much time inside <code>ngx_process_events_and_timers</code>, and distribution is bimodal, then you probably are affected by event loop stalls.</p>
<pre><code># funclatency '/srv/nginx-bazel/sbin/nginx:ngx_process_events_and_timers' -m
     msecs               : count     distribution
         0 -&amp;gt; 1          : 3799     |****************************************|
         2 -&amp;gt; 3          : 0        |                                        |
         4 -&amp;gt; 7          : 0        |                                        |
         8 -&amp;gt; 15         : 0        |                                        |
        16 -&amp;gt; 31         : 409      |****                                    |
        32 -&amp;gt; 63         : 313      |***                                     |
        64 -&amp;gt; 127        : 128      |*                                       |
</code></pre>
<p>You will need more skills to root cause and fix such issues, which is beyond the scope of this article.</p>
<h2 id="references">References<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#references" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<ul>
<li><a href="https://dropbox.tech/infrastructure/optimizing-web-servers-for-high-throughput-and-low-latency" class="external">https://dropbox.tech/infrastructure/optimizing-web-servers-for-high-throughput-and-low-latency<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
<li><a href="https://netdevconf.org/1.2/papers/bbr-netdev-1.2.new.new.pdf" class="external">https://netdevconf.org/1.2/papers/bbr-netdev-1.2.new.new.pdf<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
<li><a href="https://www.youtube.com/watch?v=aGL8a3Agj-c" class="external">https://www.youtube.com/watch?v=aGL8a3Agj-c<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
<li><a href="https://techdocs.broadcom.com/us/en/storage-and-ethernet-connectivity/ethernet-nic-controllers/bcm957xxx/adapters/Tuning.html" class="external">https://techdocs.broadcom.com/us/en/storage-and-ethernet-connectivity/ethernet-nic-controllers/bcm957xxx/adapters/Tuning.html<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
<li><a href="https://www.amd.com/content/dam/amd/en/documents/epyc-technical-docs/tuning-guides/58489_amd-epyc-9005-tg-nginx.pdf" class="external">https://www.amd.com/content/dam/amd/en/documents/epyc-technical-docs/tuning-guides/58489_amd-epyc-9005-tg-nginx.pdf<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
<li><a href="https://www.amd.com/content/dam/amd/en/documents/epyc-technical-docs/tuning-guides/58472_amd-epyc-9005-tg-linux-network.pdf" class="external">https://www.amd.com/content/dam/amd/en/documents/epyc-technical-docs/tuning-guides/58472_amd-epyc-9005-tg-linux-network.pdf<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
<li><a href="https://www.amd.com/content/dam/amd/en/documents/epyc-technical-docs/tuning-guides/amd-epyc-9004-tg-azure.pdf" class="external">https://www.amd.com/content/dam/amd/en/documents/epyc-technical-docs/tuning-guides/amd-epyc-9004-tg-azure.pdf<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> (AMD EPYC 9004 Series on Azure)</li>
<li><a href="https://cdrdv2-public.intel.com/334019/334019_Intel%20Ethernet%20700%20Series%20Linux%20Performance%20Tuning%20Guide.pdf" class="external">https://cdrdv2-public.intel.com/334019/334019_Intel%20Ethernet%20700%20Series%20Linux%20Performance%20Tuning%20Guide.pdf<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
<li><a href="https://blog.cloudflare.com/http-2-prioritization-with-nginx/" class="external">https://blog.cloudflare.com/http-2-prioritization-with-nginx/<svg aria-hidden="true" class="external-icon" style="max-width:0.8em;max-height:0.8em;" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a></li>
</ul></article><hr/><div class="page-footer"></div></div><div class="right sidebar"><div class="graph"><h3>Graph View</h3><div class="graph-outer"><div class="graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:1,&quot;scale&quot;:1.1,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:false,&quot;enableRadial&quot;:false}"></div><button class="global-graph-icon" aria-label="Global Graph"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve"><path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
                s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
                c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
                C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
                c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
                v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
                s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
                C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
                S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
                s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
                s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path></svg></button></div><div class="global-graph-outer"><div class="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.2,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:true,&quot;enableRadial&quot;:true}"></div></div></div><div class="toc desktop-only"><button type="button" class="toc-header" aria-controls="toc-180" aria-expanded="true"><h3>Table of Contents</h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><ul id="list-1" class="toc-content overflow"><li class="depth-0"><a href="#numa-topology" data-for="numa-topology">NUMA topology</a></li><li class="depth-1"><a href="#node-per-socket-nps-settings" data-for="node-per-socket-nps-settings">Node Per Socket (NPS) settings</a></li><li class="depth-0"><a href="#nic-configuration" data-for="nic-configuration">NIC configuration</a></li><li class="depth-1"><a href="#configure-nic-queues" data-for="configure-nic-queues">Configure NIC queues</a></li><li class="depth-1"><a href="#rx-and-tx-ring-sizes" data-for="rx-and-tx-ring-sizes">RX and TX ring sizes</a></li><li class="depth-1"><a href="#interrupt-coalescing" data-for="interrupt-coalescing">Interrupt coalescing</a></li><li class="depth-1"><a href="#gro-generic-receive-offload" data-for="gro-generic-receive-offload">GRO (Generic Receive Offload)</a></li><li class="depth-0"><a href="#system-configuration" data-for="system-configuration">System configuration</a></li><li class="depth-1"><a href="#linux-kernel-version" data-for="linux-kernel-version">Linux kernel version</a></li><li class="depth-1"><a href="#cpu-scaling-governor" data-for="cpu-scaling-governor">CPU scaling governor</a></li><li class="depth-1"><a href="#configure-limits" data-for="configure-limits">Configure limits</a></li><li class="depth-1"><a href="#firewall" data-for="firewall">Firewall</a></li><li class="depth-1"><a href="#transparent-hugepages-thp" data-for="transparent-hugepages-thp">Transparent hugepages (THP)</a></li><li class="depth-1"><a href="#sysctl" data-for="sysctl">sysctl</a></li><li class="depth-0"><a href="#nginx-configuration" data-for="nginx-configuration">NGINX configuration</a></li><li class="depth-1"><a href="#event-handling" data-for="event-handling">Event handling</a></li><li class="depth-1"><a href="#open-file-cache" data-for="open-file-cache">Open file cache</a></li><li class="depth-1"><a href="#http-keepalive" data-for="http-keepalive">HTTP keepalive</a></li><li class="depth-1"><a href="#buffering-requests-and-responses-with-large-body" data-for="buffering-requests-and-responses-with-large-body">Buffering requests and responses with large body</a></li><li class="depth-1"><a href="#worker-configuration" data-for="worker-configuration">Worker configuration</a></li><li class="depth-1"><a href="#logging" data-for="logging">Logging</a></li><li class="depth-1"><a href="#caching-and-compression" data-for="caching-and-compression">Caching and compression</a></li><li class="depth-1"><a href="#enable-aio-asynchronous-file-io" data-for="enable-aio-asynchronous-file-io">Enable AIO (Asynchronous file I/O)</a></li><li class="depth-1"><a href="#enable-pcre-jit" data-for="enable-pcre-jit">Enable PCRE JIT</a></li><li class="depth-1"><a href="#http2-prioritization" data-for="http2-prioritization">HTTP/2 prioritization</a></li><li class="depth-1"><a href="#detect-event-loop-stalls" data-for="detect-event-loop-stalls">Detect event loop stalls</a></li><li class="depth-1"><a href="#references" data-for="references">References</a></li><li class="overflow-end"></li></ul></div><div class="backlinks"><h3>Backlinks</h3><ul id="list-2" class="overflow"><li><a href="../../maps/NGINX-Map" class="internal">NGINX Map</a></li><li class="overflow-end"></li></ul></div></div><footer class><p>Created with <a href="https://quartz.jzhao.xyz/">Quartz v4.5.2</a> ¬© 2026</p><ul><li><a href="https://github.com/l2dy">GitHub</a></li><li><a href="https://github.com/sponsors/l2dy">Sponsor me</a></li></ul></footer></div></div></body><script type="application/javascript" data-persist="true">function n(){let t=this.parentElement;t.classList.toggle("is-collapsed");let e=t.getElementsByClassName("callout-content")[0];if(!e)return;let l=t.classList.contains("is-collapsed");e.style.gridTemplateRows=l?"0fr":"1fr"}function c(){let t=document.getElementsByClassName("callout is-collapsible");for(let e of t){let l=e.getElementsByClassName("callout-title")[0],s=e.getElementsByClassName("callout-content")[0];if(!l||!s)continue;l.addEventListener("click",n),window.addCleanup(()=>l.removeEventListener("click",n));let o=e.classList.contains("is-collapsed");s.style.gridTemplateRows=o?"0fr":"1fr"}}document.addEventListener("nav",c);
</script><script type="module" data-persist="true">function E(a,e){if(!a)return;function t(o){o.target===this&&(o.preventDefault(),o.stopPropagation(),e())}function n(o){o.key.startsWith("Esc")&&(o.preventDefault(),e())}a?.addEventListener("click",t),window.addCleanup(()=>a?.removeEventListener("click",t)),document.addEventListener("keydown",n),window.addCleanup(()=>document.removeEventListener("keydown",n))}function f(a){for(;a.firstChild;)a.removeChild(a.firstChild)}var m=class{constructor(e,t){this.container=e;this.content=t;this.setupEventListeners(),this.setupNavigationControls(),this.resetTransform()}isDragging=!1;startPan={x:0,y:0};currentPan={x:0,y:0};scale=1;MIN_SCALE=.5;MAX_SCALE=3;cleanups=[];setupEventListeners(){let e=this.onMouseDown.bind(this),t=this.onMouseMove.bind(this),n=this.onMouseUp.bind(this),o=this.onTouchStart.bind(this),r=this.onTouchMove.bind(this),i=this.onTouchEnd.bind(this),s=this.resetTransform.bind(this);this.container.addEventListener("mousedown",e),document.addEventListener("mousemove",t),document.addEventListener("mouseup",n),this.container.addEventListener("touchstart",o,{passive:!1}),document.addEventListener("touchmove",r,{passive:!1}),document.addEventListener("touchend",i),window.addEventListener("resize",s),this.cleanups.push(()=>this.container.removeEventListener("mousedown",e),()=>document.removeEventListener("mousemove",t),()=>document.removeEventListener("mouseup",n),()=>this.container.removeEventListener("touchstart",o),()=>document.removeEventListener("touchmove",r),()=>document.removeEventListener("touchend",i),()=>window.removeEventListener("resize",s))}cleanup(){for(let e of this.cleanups)e()}setupNavigationControls(){let e=document.createElement("div");e.className="mermaid-controls";let t=this.createButton("+",()=>this.zoom(.1)),n=this.createButton("-",()=>this.zoom(-.1)),o=this.createButton("Reset",()=>this.resetTransform());e.appendChild(n),e.appendChild(o),e.appendChild(t),this.container.appendChild(e)}createButton(e,t){let n=document.createElement("button");return n.textContent=e,n.className="mermaid-control-button",n.addEventListener("click",t),window.addCleanup(()=>n.removeEventListener("click",t)),n}onMouseDown(e){e.button===0&&(this.isDragging=!0,this.startPan={x:e.clientX-this.currentPan.x,y:e.clientY-this.currentPan.y},this.container.style.cursor="grabbing")}onMouseMove(e){this.isDragging&&(e.preventDefault(),this.currentPan={x:e.clientX-this.startPan.x,y:e.clientY-this.startPan.y},this.updateTransform())}onMouseUp(){this.isDragging=!1,this.container.style.cursor="grab"}onTouchStart(e){if(e.touches.length!==1)return;this.isDragging=!0;let t=e.touches[0];this.startPan={x:t.clientX-this.currentPan.x,y:t.clientY-this.currentPan.y}}onTouchMove(e){if(!this.isDragging||e.touches.length!==1)return;e.preventDefault();let t=e.touches[0];this.currentPan={x:t.clientX-this.startPan.x,y:t.clientY-this.startPan.y},this.updateTransform()}onTouchEnd(){this.isDragging=!1}zoom(e){let t=Math.min(Math.max(this.scale+e,this.MIN_SCALE),this.MAX_SCALE),n=this.content.getBoundingClientRect(),o=n.width/2,r=n.height/2,i=t-this.scale;this.currentPan.x-=o*i,this.currentPan.y-=r*i,this.scale=t,this.updateTransform()}updateTransform(){this.content.style.transform=`translate(${this.currentPan.x}px, ${this.currentPan.y}px) scale(${this.scale})`}resetTransform(){let t=this.content.querySelector("svg").getBoundingClientRect(),n=t.width/this.scale,o=t.height/this.scale;this.scale=1,this.currentPan={x:(this.container.clientWidth-n)/2,y:(this.container.clientHeight-o)/2},this.updateTransform()}},T=["--secondary","--tertiary","--gray","--light","--lightgray","--highlight","--dark","--darkgray","--codeFont"],y;document.addEventListener("nav",async()=>{let e=document.querySelector(".center").querySelectorAll("code.mermaid");if(e.length===0)return;y||=await import("https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.4.0/mermaid.esm.min.mjs");let t=y.default,n=new WeakMap;for(let r of e)n.set(r,r.innerText);async function o(){for(let s of e){s.removeAttribute("data-processed");let c=n.get(s);c&&(s.innerHTML=c)}let r=T.reduce((s,c)=>(s[c]=window.getComputedStyle(document.documentElement).getPropertyValue(c),s),{}),i=document.documentElement.getAttribute("saved-theme")==="dark";t.initialize({startOnLoad:!1,securityLevel:"loose",theme:i?"dark":"base",themeVariables:{fontFamily:r["--codeFont"],primaryColor:r["--light"],primaryTextColor:r["--darkgray"],primaryBorderColor:r["--tertiary"],lineColor:r["--darkgray"],secondaryColor:r["--secondary"],tertiaryColor:r["--tertiary"],clusterBkg:r["--light"],edgeLabelBackground:r["--highlight"]}}),await t.run({nodes:e})}await o(),document.addEventListener("themechange",o),window.addCleanup(()=>document.removeEventListener("themechange",o));for(let r=0;r<e.length;r++){let v=function(){let g=l.querySelector("#mermaid-space"),h=l.querySelector(".mermaid-content");if(!h)return;f(h);let w=i.querySelector("svg").cloneNode(!0);h.appendChild(w),l.classList.add("active"),g.style.cursor="grab",u=new m(g,h)},M=function(){l.classList.remove("active"),u?.cleanup(),u=null},i=e[r],s=i.parentElement,c=s.querySelector(".clipboard-button"),d=s.querySelector(".expand-button"),p=window.getComputedStyle(c),L=c.offsetWidth+parseFloat(p.marginLeft||"0")+parseFloat(p.marginRight||"0");d.style.right=`calc(${L}px + 0.3rem)`,s.prepend(d);let l=s.querySelector("#mermaid-container");if(!l)return;let u=null;d.addEventListener("click",v),E(l,M),window.addCleanup(()=>{u?.cleanup(),d.removeEventListener("click",v)})}});
</script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/copy-tex.min.js" type="application/javascript" data-persist="true"></script><script src="../../postscript.js" type="module" data-persist="true"></script></html>